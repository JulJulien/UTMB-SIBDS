---
title: "Vaccine"
author: "Summer"
date: "2025-07-01"
output: html_document
---

--------------------
Key
--------------------
NHS: Normal healthy subjects
ASYM: Chagas disease patients with no clinical symptoms
SYM: Chagas disease patients with clinical symptoms
ID: Identification marker for 1 of the 42 patients studied
chag_pres: person doesn't have or does have chagas disease (0 or 1)
a_or_s: whether a person is asymptomatic or symptomatic

--------------------
Definitions
--------------------
Serum: Liquid secreted after blood clots
Plasma: Liquid secreted when anti-coagulant is applied to blood
Copeptin:
- Peptide derived from the precursor of vasopressin
- Serves as a surrogate biomarker for vasopressin release
- Useful id diagnosing diabetes insipidus, heart failure, and acute myocardial infarction since vasopression is unstable in blood but copeptin is not
HnRNPA1:
- RNA binding protein involved in pre-mRNA splicing, transport, and stability
- Regulates gene expression post-transcriptionally
- Mutations associated with neurodegenerative diseases
Endostatin:
- Natural inhibtor of angiogensis
- Blocks formation of new blood vessels (tumor suppression)
Myostatin:
- Inhibits muscle growth
- Mutations that inactivate myostatin lead to muscle hypertrophy
8-OhDG:
- Marker of oxidative DNA damage
- Formed when DNA is attacked by reactive oxygen species
- Elevated levels seen in cancer, neurodegenerative diseases, diabetes, and agings. Assess oxidative stress
PARP1:
- DNA repair enzyme
- Detects DNA strand breaks and helps repair them by adding ADP-ribose chains to itself and other proteins

--------------------
AUC Results (with vs without chagas)
--------------------
Copeptin Serum: 1
Copeptin Plasma: 1
HnRNPA1 Serum:0.9888889
HnRNPA1 Plasma:0.9847222
Endostatin Serum:0.9222222
Endostatin Plasma:0.9513889
Myostatin Serum:0.75
Myostatin Plasma:0.7013889
8-OhDG Serum:0.9972222
8-OhDG Plasma:1
PARP1 Serum:1
PARP1 Plasma:1

Our model shows that Copeptin Serum/Plasma levels, HnRNPA1 Serum/Plasma levels, Endostatin Serum/Plasma levels, 8-OHDG Serum/Plasma levels, and PARP1 Serum/Plasma levels are able to discern between someone with or without chagas disease. 

--------------------
AUC Results (asymptomatic vs symptomatic)
--------------------
Copeptin Serum: 0.9822222
Copeptin Plasma: 1
HnRNPA1 Serum:0.7066667
HnRNPA1 Plasma:0.6133333
Endostatin Serum:0.8911111
Endostatin Plasma:0.9155556
Myostatin Serum: 1
Myostatin Plasma:0.9955556
8-OhDG Serum:0.9911111
8-OhDG Plasma:0.8355556
PARP1 Serum:0.6044444
PARP1 Plasma:0.5244444


Our model shows that Copeptin Serum/Plasma levels, Endostatin Serum/Plasma, Myostatin Serum/Plasma, 8-OhDG Serum/Plasma levels are able to discern between someone showing symptoms of chagas disease and someone being asymptomatic.

We can conclude that HnRNPA1 and PARP1 levels are best used as diagnostic tools for diagnosing a patient with Chagas disease while Copeptin, Endostatin, and 8-OhDG levels should remain as prognostic variables that can be seen in individuals with Chagas disease. 


--------------------
Install important packages and libraries
--------------------
```{r package}
library(broom)
library(corrplot)
library(dplyr)
library(emmeans)
library(fmsb)
library(ggplot2)
library(ggpubr)
library(ggrepel)
library(gridExtra)
library(glmnet)
library(gbm)
library(ISLR)
library(leaps)
library(MASS)
library(nnet)
library(pROC)
library(readxl)
library(rlang)
library(randomForest)
library(scales)
library(tidyverse)
library(tidyr)
library(tree)
library(writexl)
library(wesanderson)
```

--------------------
Load data from excel
--------------------
```{r load}
file_path <- ("/Users/summerjohnson/Documents/GitHub/UTMB-SIBDS/proteinparam.xlsx")
data <- read_xlsx("/Users/summerjohnson/Documents/GitHub/UTMB-SIBDS/proteinparam.xlsx")

#Create columns for each protein parameter and test, new column ordinal chagas present
data <- data %>%
  pivot_wider(names_from = Moleculae, values_from = c(Serum, Plasma),
              names_glue = "{Moleculae}_{.value}") %>%
  mutate(
    chag = case_when(
      Symptom == "NHS" ~ 0, 
      Symptom == "ASYM" | Symptom == "SYM" ~ 1,
      TRUE ~ NA_real_
    ),
    sym = case_when(
      Symptom == "ASYM" ~ 0,
      Symptom == "SYM" ~ 1,
      TRUE ~ NA_real_
    )
  )
```


--------------------
EDA
- boxplots showing protein parameters mapped by symptom and presence of disease
--------------------
``` {r EDA}

marker_labels <- c(
  "Copeptin_Serum" = "Copeptin (Serum)",
  "Copeptin_Plasma" = "Copeptin (Plasma)",
  "HnRNPA1_Serum" = "HnRNPA1 (Serum)",
  "HnRNPA1_Plasma" = "HnRNPA1 (Plasma)",
  "Endostatin_Serum" = "Endostatin (Serum)",
  "Endostatin_Plasma" = "Endostatin (Plasma)",
  "etOhDG_Serum" = "8-OhDG (Serum)",
  "etOhDG_Plasma" = "8-OhDG (Plasma)",
  "Myostatin_Serum" = "Myostatin (Serum)",
  "Myostatin_Plasma" = "Myostatin (Plasma)",
  "PARP1_Serum" = "PARP1 (Serum)",
  "PARP1_Plasma" = "PARP1 (Plasma)"
)


#Chag boxplot
df_long <- data %>%
  pivot_longer(cols = ends_with("_Serum") | ends_with("_Plasma"),
               names_to = "marker",
               values_to = "value") 

chag_labels <- c("0" = "No Chagas", "1" = "Has Chagas")

ggplot(df_long, aes(x = factor(chag), y = value, fill = factor(chag))) +
  geom_boxplot() +
  facet_wrap(~ marker, scales = "free", labeller = labeller(marker = marker_labels)) +
  scale_fill_manual(
    name = "Chagas Status",
    values = c("0" = "#FF61CC", "1" = "#00A9FF"),  
    labels = chag_labels        
  ) +
  labs(
    x = "Chagas Status",
    y = "Protein Level",
    fill = "Symptom Status"   
  ) +
  theme_minimal() 

#Sym boxplot
df_long2 <- data %>%
  pivot_longer(cols = ends_with("_Serum") | ends_with("_Plasma"),
               names_to = "marker",
               values_to = "value") %>%
  filter(sym == 0 | sym == 1)

sym_labels <- c("0" = "Asymptomatic", "1" = "Symptomatic")

ggplot(df_long2, aes(x = factor(sym), y = value, fill = factor(sym))) +
  geom_boxplot() +
  facet_wrap(~ marker, scales = "free", labeller = labeller(marker = marker_labels)) +
  scale_fill_manual(
    name = "Chagas Symptom Status",
    values = c("0" = "#1ABC9C", "1" = "#FF5733"),  
    labels = sym_labels        
  ) +
  labs(
    x = "Chagas Symptom Status",
    y = "Protein Level",
    fill = "Symptom Status"   
  ) +
  theme_minimal() 
  

```



--------------------
Can each protein level predict whether or not someone has chagas disease?
*logistic regression, ROC, AUC*
--------------------
``` {r user}
#Loop for each protein and sample
run_logistic_analysis <- function(data, protein_name, sample_type = c("Serum", "Plasma")) {
  sample_type <- match.arg(sample_type)
  
  #Construct the column name
  var_name <- paste0(protein_name, "_", sample_type)
  
  #Check if the variable exists
  if (!var_name %in% names(data)) {
    stop(paste("Variable", var_name, "not found in the data."))
  }
  
  #Formula for logistic regression
  formula <- as.formula(paste("chag ~", var_name))
  
  #Fit logistic regression model
  log.reg <- glm(formula, data = data, family = "binomial")
  print(summary(log.reg))
  
  #Odds ratios and CI
  cat("\nOdds Ratios:\n")
  print(exp(coef(log.reg)))
  
  cat("\n95% CI for Odds Ratios:\n")
  print(exp(confint(log.reg)))
  
  #Predicted probabilities and classes
  pred.prob <- predict(log.reg, type = "response")
  pred.class <- ifelse(pred.prob > 0.5, 1, 0)
  
  #ROC and AUC
  roc_log <- roc(data$chag, pred.prob)
  cat("\nAUC:", auc(roc_log), "\n")
  plot(roc_log, main = paste("ROC Curve -", var_name))
  
  #Regularization with cv.glmnet (L2 penalty: alpha = 0)
  set.seed(123)
  x <- cbind(var = data[[var_name]], dummy = rnorm(nrow(data), 0, 1e-6))
  x <- as.matrix(x)
  y <- as.factor(data$chag)
  
  cvfit <- cv.glmnet(x, y, family = "binomial", alpha = 0)
  plot(cvfit, main = paste("CV Error -", var_name))
  cat("\nRegularized Coefficients (lambda.min):\n")
  print(coef(cvfit, s = "lambda.min"))
  
  invisible(list(model = log.reg, auc = auc(roc_log), cv_model = cvfit))
}

#Run logistic regression for each protein and sample
run_logistic_analysis(data, protein_name = "Copeptin", sample_type = "Serum")
run_logistic_analysis(data, protein_name = "Copeptin", sample_type = "Plasma")
run_logistic_analysis(data, protein_name = "HnRNPA1", sample_type = "Serum")
run_logistic_analysis(data, protein_name = "HnRNPA1", sample_type = "Plasma")
run_logistic_analysis(data, protein_name = "Endostatin", sample_type = "Serum")
run_logistic_analysis(data, protein_name = "Endostatin", sample_type = "Plasma")
run_logistic_analysis(data, protein_name = "Myostatin", sample_type = "Serum")
run_logistic_analysis(data, protein_name = "Myostatin", sample_type = "Plasma")
run_logistic_analysis(data, protein_name = "etOhDG", sample_type = "Serum")
run_logistic_analysis(data, protein_name = "etOhDG", sample_type = "Plasma")
run_logistic_analysis(data, protein_name = "PARP1", sample_type = "Serum")
run_logistic_analysis(data, protein_name = "PARP1", sample_type = "Plasma")

```
--------------------
AUC Results (with vs without chagas)
--------------------
Copeptin Serum: 1
Copeptin Plasma: 1
HnRNPA1 Serum:0.9888889
HnRNPA1 Plasma:0.9847222
Endostatin Serum:0.9222222
Endostatin Plasma:0.9513889
Myostatin Serum:0.75
Myostatin Plasma:0.7013889
8-OhDG Serum:0.9972222
8-OhDG Plasma:1
PARP1 Serum:1
PARP1 Plasma:1

Our model shows that Copeptin Serum/Plasma levels, HnRNPA1 Serum/Plasma levels, Endostatin Serum/Plasma levels, 8-OHDG Serum/Plasma levels, and PARP1 Serum/Plasma levels are able to discern between someone with or without chagas disease. 


--------------------
Can each protein level predict whether or not someone is symptomatic?
*logistic regression, ROC, AUC*
--------------------
``` {r newlog}
run_logistic_analysis_sym <- function(data, protein_name, sample_type = c("Serum", "Plasma")) {
  sample_type <- match.arg(sample_type)
  var_name <- paste0(protein_name, "_", sample_type)
  
  if (!var_name %in% names(data)) {
    stop(paste("Variable", var_name, "not found in the data."))
  }
  
  # Remove rows with NA in outcome or predictor
  clean_data <- data[!is.na(data[[var_name]]) & !is.na(data$sym), ]
  
  if (nrow(clean_data) < 5) {
    warning(paste("Too few complete cases for", var_name))
    return(NULL)
  }
  
  # Logistic regression
  formula <- as.formula(paste("sym ~", var_name))
  log.reg <- glm(formula, data = clean_data, family = "binomial")
  print(summary(log.reg))
  
  # Odds ratios and confidence intervals
  cat("\nOdds Ratios:\n")
  print(exp(coef(log.reg)))
  
  cat("\n95% CI for Odds Ratios:\n")
  print(exp(confint(log.reg)))
  
  # Predict probabilities
  pred.prob <- predict(log.reg, type = "response")
  
  # ROC and AUC
  roc_log <- roc(clean_data$sym, pred.prob)
  cat("\nAUC:", auc(roc_log), "\n")
  plot(roc_log, main = paste("ROC Curve - Symptomatic ~", var_name))
  
  # Ridge regularization (dummy added to avoid single-column matrix issues)
  set.seed(123)
  x <- cbind(var = clean_data[[var_name]], dummy = rnorm(nrow(clean_data), 0, 1e-6))
  x <- as.matrix(x)
  y <- as.factor(clean_data$sym)
  
  cvfit <- cv.glmnet(x, y, family = "binomial", alpha = 0)
  plot(cvfit, main = paste("CV Error (Ridge) -", var_name))
  cat("\nRegularized Coefficients (lambda.min):\n")
  print(coef(cvfit, s = "lambda.min"))
  
  invisible(list(model = log.reg, auc = auc(roc_log), cv_model = cvfit))
}


# Serum and Plasma for all proteins, outcome: SYM
run_logistic_analysis_sym(data, "Copeptin", "Serum")
run_logistic_analysis_sym(data, "Copeptin", "Plasma")
run_logistic_analysis_sym(data, "HnRNPA1", "Serum")
run_logistic_analysis_sym(data, "HnRNPA1", "Plasma")
run_logistic_analysis_sym(data, "Endostatin", "Serum")
run_logistic_analysis_sym(data, "Endostatin", "Plasma")
run_logistic_analysis_sym(data, "Myostatin", "Serum")
run_logistic_analysis_sym(data, "Myostatin", "Plasma")
run_logistic_analysis_sym(data, "etOhDG", "Serum")
run_logistic_analysis_sym(data, "etOhDG", "Plasma")
run_logistic_analysis_sym(data, "PARP1", "Serum")
run_logistic_analysis_sym(data, "PARP1", "Plasma")

```
--------------------
AUC Results (asymptomatic vs symptomatic)
--------------------
Copeptin Serum: 0.9822222
Copeptin Plasma: 1
HnRNPA1 Serum:0.7066667
HnRNPA1 Plasma:0.6133333
Endostatin Serum:0.8911111
Endostatin Plasma:0.9155556
Myostatin Serum: 1
Myostatin Plasma:0.9955556
8-OhDG Serum:0.9911111
8-OhDG Plasma:0.8355556
PARP1 Serum:0.6044444
PARP1 Plasma:0.5244444


Our model shows that Copeptin Serum/Plasma levels, Endostatin Serum/Plasma, Myostatin Serum/Plasma, 8-OhDG Serum/Plasma levels are able to discern between someone showing symptoms of chagas disease and someone being asymptomatic.

We can conclude that HnRNPA1 and PARP1 levels are best used as diagnostic tools for diagnosing a patient with Chagas disease while Copeptin, Endostatin, and 8-OhDG levels should remain as prognostic variables that can be seen in individuals with Chagas disease. 


--------------------
Graphing
- graphing the AUC results
--------------------
``` {r graphing}

#Create a tidy dataframe of AUC results
diagnosis_auc <- tribble(
  ~Biomarker, ~Sample, ~AUC,
  "Copeptin", "Serum", 1,
  "Copeptin", "Plasma", 1,
  "HnRNPA1", "Serum", 0.9888889,
  "HnRNPA1", "Plasma", 0.9847222,
  "Endostatin", "Serum", 0.9222222,
  "Endostatin", "Plasma", 0.9513889,
  "Myostatin", "Serum", 0.75,
  "Myostatin", "Plasma", 0.7013889,
  "8-OhDG", "Serum", 0.9972222,
  "8-OhDG", "Plasma", 1,
  "PARP1", "Serum", 1,
  "PARP1", "Plasma", 1
)

prognosis_auc <- tribble(
  ~Biomarker, ~Sample, ~AUC,
  "Copeptin", "Serum", 0.9822222,
  "Copeptin", "Plasma", 1,
  "HnRNPA1", "Serum", 0.7066667,
  "HnRNPA1", "Plasma", 0.6133333,
  "Endostatin", "Serum", 0.8911111,
  "Endostatin", "Plasma", 0.9155556,
  "Myostatin", "Serum", 1,
  "Myostatin", "Plasma", 0.9955556,
  "8-OhDG", "Serum", 0.9911111,
  "8-OhDG", "Plasma", 0.8355556,
  "PARP1", "Serum", 0.6044444,
  "PARP1", "Plasma", 0.5244444
)

#Categorize AUC levels
auc_category <- function(x) {
  case_when(
    x >= 0.9 ~ "Excellent (≥ 0.9)",
    x >= 0.8 ~ "Good (0.8–0.9)",
    TRUE ~ "Moderate/Low (< 0.8)"
  )
}

#Category columns
diagnosis_auc <- diagnosis_auc %>%
  mutate(Category = auc_category(AUC),
         Group = "With vs W/o Chagas")

prognosis_auc <- prognosis_auc %>%
  mutate(Category = auc_category(AUC),
         Group = "Asym vs Sym")

#Combine
combined_auc <- bind_rows(diagnosis_auc, prognosis_auc)

#Visualize
ggplot(combined_auc, aes(x = reorder(paste(Biomarker, Sample, sep = " "), AUC), y = AUC, fill = Category)) +
  geom_col() +
  coord_flip() +
  facet_wrap(~Group, scales = "free_y") +
  scale_fill_manual(values = wes_palette("AsteroidCity1", n = 3, type = "discrete")) +
  labs(title = "Predictability of Protein Parameters for Chagas Disease",
       x = "Biomarker",
       y = "AUC",
       fill = "AUC Category") +
  theme_minimal(base_size = 12) +
  theme( 
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.y = element_text(face = "bold"),
    axis.text.x = element_text(face = "bold"),
    plot.title = element_text(size = 18, face = "bold"),
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(face = "bold"),
    strip.text = element_text(size = 12, face = "bold")
    )
  

# Classification vector
classification_df <- tribble(
  ~Biomarker, ~Classification,
  "Copeptin", "Both",
  "HnRNPA1", "Diagnostic",
  "Endostatin", "Both",
  "Myostatin", "Prognostic",
  "8-OhDG", "Both",
  "PARP1", "Diagnostic"
)

# Merge classification into AUC data
combined_auc_labeled <- combined_auc %>%
  left_join(classification_df, by = "Biomarker")

# Plot with biomarker role
ggplot(combined_auc_labeled, aes(x = reorder(paste(Biomarker, Sample, sep = " "), AUC), 
                                 y = AUC, fill = Classification)) +
  geom_col() +
  coord_flip() +
  facet_wrap(~Group, scales = "free_y") +
  scale_fill_manual(values = wes_palette("AsteroidCity2", n = 3, type = "discrete")) +
  labs(title = "Biomarkers classified as Diagnostic, Prognostic, or Both",
       x = "Biomarker",
       y = "AUC",
       fill = "Biomarker Role") +
  theme_minimal(base_size = 12) +
  theme( 
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.y = element_text(face = "bold"),
    axis.text.x = element_text(face = "bold"),
    plot.title = element_text(size = 18, face = "bold"),
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(face = "bold"),
    strip.text = element_text(size = 12, face = "bold")
    )
  

```



--------------------
Radar Plot
- radar plot for protein parameter average for each group
- just take the log of max, min, average
--------------------
``` {r radar}

#Group averages
avg_data <- data %>%
  group_by(Symptom) %>%
  summarise(across(matches("(_Serum|_Plasma)$"), mean, na.rm = TRUE)) %>%
  as.data.frame()

log_data <- avg_data %>%
  mutate(across(where(is.numeric), log))

# Set rownames from Symptom and remove that column
rownames(log_data) <- log_data$Symptom
log_data$Symptom <- NULL

# Set min and max values explicitly
min_val <- 0  # your observed raw minimum
max_val <- 8  # your observed raw maximum

custom_labels <- c("Copeptin (S)", "HnRNPA1 (S)", "Endostatin (S)", "Myostatin (S)",
                   "8-OHdG (S)", "PARP1 (S)", "Copeptin (P)", "HnRNPA1 (P)", "Endostatin (P)", "Myostatin (P)",
                   "8-OHdG (P)", "PARP1 (P)")

# Create df with required min and max rows
df_radar <- log_data
colnames(df_radar) <- custom_labels 
df_radar <- rbind(rep(max_val, ncol(df_radar)),
                  rep(min_val, ncol(df_radar)),
                  df_radar)

# Plot radar chart with custom axis labels
radarchart(df_radar,
           axistype = 1,
           caxislabels = round(seq(min_val, max_val, length.out = 5), 2),
           pcol = wes_palette("Darjeeling1"),
           plwd = 2,
           cglcol = "grey",
           cglty = 1,
           axislabcol = "black",
           vlcex = 0.9,
           title = "Log Averages of Protein Parameters by Symptom")

# Add legend for the groups
legend("bottomleft",
       legend = rownames(df_radar)[3:nrow(df_radar)],
       col = wes_palette("Darjeeling1"),
       lty = 1, lwd = 4, bty = "n")



```
















