---
title: "Vaccine"
author: "Summer"
date: "2025-07-01"
output: html_document
---

--------------------
Key
--------------------
NHS: Normal healthy subjects
ASYM: Chagas disease patients with no clinical symptoms
SYM: Chagas disease patients with clinical symptoms
ID: Identification marker for 1 of the 42 patients studied
chag_pres: person doesn't have or does have chagas disease (0 or 1)
a_or_s: whether a person is asymptomatic or symptomatic

--------------------
Definitions
--------------------
Serum: Liquid secreted after blood clots
Plasma: Liquid secreted when anti-coagulant is applied to blood
Copeptin:
- Peptide derived from the precursor of vasopressin
- Serves as a surrogate biomarker for vasopressin release
- Useful id diagnosing diabetes insipidus, heart failure, and acute myocardial infarction since vasopression is unstable in blood but copeptin is not
HnRNPA1:
- RNA binding protein involved in pre-mRNA splicing, transport, and stability
- Regulates gene expression post-transcriptionally
- Mutations associated with neurodegenerative diseases
Endostatin:
- Natural inhibtor of angiogensis
- Blocks formation of new blood vessels (tumor suppression)
Myostatin:
- Inhibits muscle growth
- Mutations that inactivate myostatin lead to muscle hypertrophy
8-OhDG:
- Marker of oxidative DNA damage
- Formed when DNA is attacked by reactive oxygen species
- Elevated levels seen in cancer, neurodegenerative diseases, diabetes, and agings. Assess oxidative stress
PARP1:
- DNA repair enzyme
- Detects DNA strand breaks and helps repair them by adding ADP-ribose chains to itself and other proteins

--------------------
AUC Results (with vs without chagas)
--------------------
Copeptin Serum: 1
Copeptin Plasma: 1
HnRNPA1 Serum:0.9888889
HnRNPA1 Plasma:0.9847222
Endostatin Serum:0.9222222
Endostatin Plasma:0.9513889
Myostatin Serum:0.75
Myostatin Plasma:0.7013889
8-OhDG Serum:0.9972222
8-OhDG Plasma:1
PARP1 Serum:1
PARP1 Plasma:1

Our model shows that Copeptin Serum/Plasma levels, HnRNPA1 Serum/Plasma levels, Endostatin Serum/Plasma levels, 8-OHDG Serum/Plasma levels, and PARP1 Serum/Plasma levels are able to discern between someone with or without chagas disease. 

--------------------
AUC Results (asymptomatic vs symptomatic)
--------------------
Copeptin Serum: 0.9822222
Copeptin Plasma: 1
HnRNPA1 Serum:0.7066667
HnRNPA1 Plasma:0.6133333
Endostatin Serum:0.8911111
Endostatin Plasma:0.9155556
Myostatin Serum: 1
Myostatin Plasma:0.9955556
8-OhDG Serum:0.9911111
8-OhDG Plasma:0.8355556
PARP1 Serum:0.6044444
PARP1 Plasma:0.5244444


Our model shows that Copeptin Serum/Plasma levels, Endostatin Serum/Plasma, Myostatin Serum/Plasma, 8-OhDG Serum/Plasma levels are able to discern between someone showing symptoms of chagas disease and someone being asymptomatic.

We can conclude that HnRNPA1 and PARP1 levels are best used as diagnostic tools for diagnosing a patient with Chagas disease while Copeptin, Endostatin, and 8-OhDG levels should remain as prognostic variables that can be seen in individuals with Chagas disease. 


--------------------
Install important packages and libraries
--------------------
```{r package}
library(broom)
library(corrplot)
library(dplyr)
library(emmeans)
library(ggplot2)
library(ggpubr)
library(ggrepel)
library(gridExtra)
library(grid)
library(glmnet)
library(gbm)
library(ISLR)
library(leaps)
library(MASS)
library(nnet)
library(pROC)
library(readxl)
library(rlang)
library(randomForest)
library(tidyverse)
library(tidyr)
library(tree)
library(writexl)
```

--------------------
Load data from excel
--------------------
```{r load}
file_path <- ("C:/Users/cajgarza/Documents/UTMB-SIBDS/proteinparam.xlsx")
data <- read_xlsx("C:/Users/cajgarza/Documents/UTMB-SIBDS/proteinparam.xlsx")

#Create columns for each protein parameter and test, new column ordinal chagas present
data <- data %>%
  pivot_wider(names_from = Moleculae, values_from = c(Serum, Plasma),
              names_glue = "{Moleculae}_{.value}") %>%
  mutate(
    chag = case_when(
      Symptom == "NHS" ~ 0, 
      Symptom == "ASYM" | Symptom == "SYM" ~ 1,
      TRUE ~ NA_real_
    ),
    sym = case_when(
      Symptom == "ASYM" ~ 0,
      Symptom == "SYM" ~ 1,
      TRUE ~ NA_real_
    )
  )
```


--------------------
EDA
--------------------
``` {r EDA}

marker_labels <- c(
  "Copeptin_Serum" = "Copeptin (Serum)",
  "Copeptin_Plasma" = "Copeptin (Plasma)",
  "HnRNPA1_Serum" = "HnRNPA1 (Serum)",
  "HnRNPA1_Plasma" = "HnRNPA1 (Plasma)",
  "Endostatin_Serum" = "Endostatin (Serum)",
  "Endostatin_Plasma" = "Endostatin (Plasma)",
  "etOhDG_Serum" = "8-OhDG (Serum)",
  "etOhDG_Plasma" = "8-OhDG (Plasma)",
  "Myostatin_Serum" = "Myostatin (Serum)",
  "Myostatin_Plasma" = "Myostatin (Plasma)",
  "PARP1_Serum" = "PARP1 (Serum)",
  "PARP1_Plasma" = "PARP1 (Plasma)"
)


#Chag boxplot
df_long <- data %>%
  pivot_longer(cols = ends_with("_Serum") | ends_with("_Plasma"),
               names_to = "marker",
               values_to = "value") 

chag_labels <- c("0" = "No Chagas", "1" = "Has Chagas")

ggplot(df_long, aes(x = factor(chag), y = value, fill = factor(chag))) +
  geom_boxplot() +
  facet_wrap(~ marker, scales = "free", labeller = labeller(marker = marker_labels)) +
  scale_fill_manual(
    name = "Chagas Status",
    values = c("0" = "#FF61CC", "1" = "#00A9FF"),  
    labels = chag_labels        
  ) +
  labs(
    x = "Chagas Status",
    y = "Protein Level",
    fill = "Symptom Status"   
  ) +
  theme_minimal() +
  theme(
    plot.background = element_rect(fill = "cornsilk", color = NA),
    panel.background = element_rect(fill = "cornsilk", color = NA)
  )

#Sym boxplot
df_long2 <- data %>%
  pivot_longer(cols = ends_with("_Serum") | ends_with("_Plasma"),
               names_to = "marker",
               values_to = "value") %>%
  filter(sym == 0 | sym == 1)

sym_labels <- c("0" = "Asymptomatic", "1" = "Symptomatic")

ggplot(df_long2, aes(x = factor(sym), y = value, fill = factor(sym))) +
  geom_boxplot() +
  facet_wrap(~ marker, scales = "free", labeller = labeller(marker = marker_labels)) +
  scale_fill_manual(
    name = "Chagas Symptom Status",
    values = c("0" = "#1ABC9C", "1" = "#FF5733"),  
    labels = sym_labels        
  ) +
  labs(
    x = "Chagas Symptom Status",
    y = "Protein Level",
    fill = "Symptom Status"   
  ) +
  theme_minimal() +
  theme(
    plot.background = element_rect(fill = "cornsilk", color = NA),
    panel.background = element_rect(fill = "cornsilk", color = NA)
  )

```



--------------------
Can each protein level predict whether or not someone has chagas disease?
*logistic regression, ROC, AUC*
--------------------
``` {r user}
#Loop for each protein and sample
run_logistic_analysis <- function(data, protein_name, sample_type = c("Serum", "Plasma")) {
  sample_type <- match.arg(sample_type)
  
  #Construct the column name
  var_name <- paste0(protein_name, "_", sample_type)
  
  #Check if the variable exists
  if (!var_name %in% names(data)) {
    stop(paste("Variable", var_name, "not found in the data."))
  }
  
  #Formula for logistic regression
  formula <- as.formula(paste("chag ~", var_name))
  
  #Fit logistic regression model
  log.reg <- glm(formula, data = data, family = "binomial")
  print(summary(log.reg))
  
  #Odds ratios and CI
  cat("\nOdds Ratios:\n")
  print(exp(coef(log.reg)))
  
  cat("\n95% CI for Odds Ratios:\n")
  print(exp(confint(log.reg)))
  
  #Predicted probabilities and classes
  pred.prob <- predict(log.reg, type = "response")
  pred.class <- ifelse(pred.prob > 0.5, 1, 0)
  
  #ROC and AUC
  roc_log <- roc(data$chag, pred.prob)
  cat("\nAUC:", auc(roc_log), "\n")
  plot(roc_log, main = paste("ROC Curve -", var_name))
  
  #Regularization with cv.glmnet (L2 penalty: alpha = 0)
  set.seed(123)
  x <- cbind(var = data[[var_name]], dummy = rnorm(nrow(data), 0, 1e-6))
  x <- as.matrix(x)
  y <- as.factor(data$chag)
  
  cvfit <- cv.glmnet(x, y, family = "binomial", alpha = 0)
  plot(cvfit, main = paste("CV Error -", var_name))
  cat("\nRegularized Coefficients (lambda.min):\n")
  print(coef(cvfit, s = "lambda.min"))
  
  invisible(list(model = log.reg, auc = auc(roc_log), cv_model = cvfit))
}

#Run logistic regression for each protein and sample
run_logistic_analysis(data, protein_name = "Copeptin", sample_type = "Serum")
run_logistic_analysis(data, protein_name = "Copeptin", sample_type = "Plasma")
run_logistic_analysis(data, protein_name = "HnRNPA1", sample_type = "Serum")
run_logistic_analysis(data, protein_name = "HnRNPA1", sample_type = "Plasma")
run_logistic_analysis(data, protein_name = "Endostatin", sample_type = "Serum")
run_logistic_analysis(data, protein_name = "Endostatin", sample_type = "Plasma")
run_logistic_analysis(data, protein_name = "Myostatin", sample_type = "Serum")
run_logistic_analysis(data, protein_name = "Myostatin", sample_type = "Plasma")
run_logistic_analysis(data, protein_name = "etOhDG", sample_type = "Serum")
run_logistic_analysis(data, protein_name = "etOhDG", sample_type = "Plasma")
run_logistic_analysis(data, protein_name = "PARP1", sample_type = "Serum")
run_logistic_analysis(data, protein_name = "PARP1", sample_type = "Plasma")

```
--------------------
AUC Results (with vs without chagas)
--------------------
Copeptin Serum: 1
Copeptin Plasma: 1
HnRNPA1 Serum:0.9888889
HnRNPA1 Plasma:0.9847222
Endostatin Serum:0.9222222
Endostatin Plasma:0.9513889
Myostatin Serum:0.75
Myostatin Plasma:0.7013889
8-OhDG Serum:0.9972222
8-OhDG Plasma:1
PARP1 Serum:1
PARP1 Plasma:1

Our model shows that Copeptin Serum/Plasma levels, HnRNPA1 Serum/Plasma levels, Endostatin Serum/Plasma levels, 8-OHDG Serum/Plasma levels, and PARP1 Serum/Plasma levels are able to discern between someone with or without chagas disease. 


--------------------
Can each protein level predict whether or not someone is symptomatic?
*logistic regression, ROC, AUC*
--------------------
``` {r newlog}
run_logistic_analysis_sym <- function(data, protein_name, sample_type = c("Serum", "Plasma")) {
  sample_type <- match.arg(sample_type)
  var_name <- paste0(protein_name, "_", sample_type)
  
  if (!var_name %in% names(data)) {
    stop(paste("Variable", var_name, "not found in the data."))
  }
  
  # Remove rows with NA in outcome or predictor
  clean_data <- data[!is.na(data[[var_name]]) & !is.na(data$sym), ]
  
  if (nrow(clean_data) < 5) {
    warning(paste("Too few complete cases for", var_name))
    return(NULL)
  }
  
  # Logistic regression
  formula <- as.formula(paste("sym ~", var_name))
  log.reg <- glm(formula, data = clean_data, family = "binomial")
  print(summary(log.reg))
  
  # Odds ratios and confidence intervals
  cat("\nOdds Ratios:\n")
  print(exp(coef(log.reg)))
  
  cat("\n95% CI for Odds Ratios:\n")
  print(exp(confint(log.reg)))
  
  # Predict probabilities
  pred.prob <- predict(log.reg, type = "response")
  
  # ROC and AUC
  roc_log <- roc(clean_data$sym, pred.prob)
  cat("\nAUC:", auc(roc_log), "\n")
  plot(roc_log, main = paste("ROC Curve - Symptomatic ~", var_name))
  
  # Ridge regularization (dummy added to avoid single-column matrix issues)
  set.seed(123)
  x <- cbind(var = clean_data[[var_name]], dummy = rnorm(nrow(clean_data), 0, 1e-6))
  x <- as.matrix(x)
  y <- as.factor(clean_data$sym)
  
  cvfit <- cv.glmnet(x, y, family = "binomial", alpha = 0)
  plot(cvfit, main = paste("CV Error (Ridge) -", var_name))
  cat("\nRegularized Coefficients (lambda.min):\n")
  print(coef(cvfit, s = "lambda.min"))
  
  invisible(list(model = log.reg, auc = auc(roc_log), cv_model = cvfit))
}


# Serum and Plasma for all proteins, outcome: SYM
run_logistic_analysis_sym(data, "Copeptin", "Serum")
run_logistic_analysis_sym(data, "Copeptin", "Plasma")
run_logistic_analysis_sym(data, "HnRNPA1", "Serum")
run_logistic_analysis_sym(data, "HnRNPA1", "Plasma")
run_logistic_analysis_sym(data, "Endostatin", "Serum")
run_logistic_analysis_sym(data, "Endostatin", "Plasma")
run_logistic_analysis_sym(data, "Myostatin", "Serum")
run_logistic_analysis_sym(data, "Myostatin", "Plasma")
run_logistic_analysis_sym(data, "etOhDG", "Serum")
run_logistic_analysis_sym(data, "etOhDG", "Plasma")
run_logistic_analysis_sym(data, "PARP1", "Serum")
run_logistic_analysis_sym(data, "PARP1", "Plasma")


```
--------------------
AUC Results (asymptomatic vs symptomatic)
--------------------
Copeptin Serum: 0.9822222
Copeptin Plasma: 1
HnRNPA1 Serum:0.7066667
HnRNPA1 Plasma:0.6133333
Endostatin Serum:0.8911111
Endostatin Plasma:0.9155556
Myostatin Serum: 1
Myostatin Plasma:0.9955556
8-OhDG Serum:0.9911111
8-OhDG Plasma:0.8355556
PARP1 Serum:0.6044444
PARP1 Plasma:0.5244444


Our model shows that Copeptin Serum/Plasma levels, Endostatin Serum/Plasma, Myostatin Serum/Plasma, 8-OhDG Serum/Plasma levels are able to discern between someone showing symptoms of chagas disease and someone being asymptomatic.

We can conclude that HnRNPA1 and PARP1 levels are best used as diagnostic tools for diagnosing a patient with Chagas disease while Copeptin, Endostatin, and 8-OhDG levels should remain as prognostic variables that can be seen in individuals with Chagas disease. 



``` {r graphing}

#Create a tidy dataframe of AUC results
diagnosis_auc <- tribble(
  ~Biomarker, ~Sample, ~AUC,
  "Copeptin", "Serum", 1,
  "Copeptin", "Plasma", 1,
  "HnRNPA1", "Serum", 0.9888889,
  "HnRNPA1", "Plasma", 0.9847222,
  "Endostatin", "Serum", 0.9222222,
  "Endostatin", "Plasma", 0.9513889,
  "Myostatin", "Serum", 0.75,
  "Myostatin", "Plasma", 0.7013889,
  "8-OhDG", "Serum", 0.9972222,
  "8-OhDG", "Plasma", 1,
  "PARP1", "Serum", 1,
  "PARP1", "Plasma", 1
)

prognosis_auc <- tribble(
  ~Biomarker, ~Sample, ~AUC,
  "Copeptin", "Serum", 0.9822222,
  "Copeptin", "Plasma", 1,
  "HnRNPA1", "Serum", 0.7066667,
  "HnRNPA1", "Plasma", 0.6133333,
  "Endostatin", "Serum", 0.8911111,
  "Endostatin", "Plasma", 0.9155556,
  "Myostatin", "Serum", 1,
  "Myostatin", "Plasma", 0.9955556,
  "8-OhDG", "Serum", 0.9911111,
  "8-OhDG", "Plasma", 0.8355556,
  "PARP1", "Serum", 0.6044444,
  "PARP1", "Plasma", 0.5244444
)

#Categorize AUC levels
auc_category <- function(x) {
  case_when(
    x >= 0.9 ~ "Excellent (≥ 0.9)",
    x >= 0.8 ~ "Good (0.8–0.9)",
    TRUE ~ "Moderate/Low (< 0.8)"
  )
}

#Category columns
diagnosis_auc <- diagnosis_auc %>%
  mutate(Category = auc_category(AUC),
         Group = "With vs W/o Chagas")

prognosis_auc <- prognosis_auc %>%
  mutate(Category = auc_category(AUC),
         Group = "Asym vs Sym")

#Combine
combined_auc <- bind_rows(diagnosis_auc, prognosis_auc)

#Visualize
ggplot(combined_auc, aes(x = reorder(paste(Biomarker, Sample, sep = " "), AUC), y = AUC, fill = Category)) +
  geom_col() +
  coord_flip() +
  facet_wrap(~Group, scales = "free_y") +
  scale_fill_manual(values = c("Excellent (≥ 0.9)" = "#D14E72FF",
                               "Good (0.8–0.9)" = "#FBA238FF",
                               "Moderate/Low (< 0.8)" = "#F7E225FF")) +
  labs(title = "AUC Values for Biomarkers in Chagas Disease",
       subtitle = "Predictability of Protein Parameters for Chagas Disease",
       x = "Biomarker",
       y = "AUC",
       fill = "AUC Category") +
  theme_minimal(base_size = 12) +
  theme(
    plot.background = element_rect(fill = "cornsilk", color = NA),
    panel.background = element_rect(fill = "cornsilk", color = NA)
  )
ggsave("AUC_Results.png", width = 8, height = 6, dpi = 300)

# Classification vector
classification_df <- tribble(
  ~Biomarker, ~Classification,
  "Copeptin", "Both",
  "HnRNPA1", "Diagnostic",
  "Endostatin", "Both",
  "Myostatin", "Prognostic",
  "8-OhDG", "Both",
  "PARP1", "Diagnostic"
)

# Merge classification into AUC data
combined_auc_labeled <- combined_auc %>%
  left_join(classification_df, by = "Biomarker")

# Plot with biomarker role
ggplot(combined_auc_labeled, aes(x = reorder(paste(Biomarker, Sample, sep = " "), AUC), 
                                 y = AUC, fill = Classification)) +
  geom_col() +
  coord_flip() +
  facet_wrap(~Group, scales = "free_y") +
  scale_fill_manual(values = c("Diagnostic" = "#2d0594FF",
                               "Prognostic" = "#9512A1FF",
                               "Both" = "#DD5E66FF")) +
  labs(title = "AUC Values for Biomarkers in Chagas Disease",
       subtitle = "Biomarkers classified as Diagnostic, Prognostic, or Both",
       x = "Biomarker",
       y = "AUC",
       fill = "Biomarker Role") +
  theme_minimal(base_size = 12) +
  theme(
    plot.background = element_rect(fill = "cornsilk", color = NA),
    panel.background = element_rect(fill = "cornsilk", color = NA)
  )
ggsave("AUC_Results_with_Roles.png", width = 8, height = 6, dpi = 300)

```


```{r Mitochondrial DNA dataframe}

mdata <- read_xlsx("MitochondrialDNA.xlsx")

# "disease" column for asym,sym (1) and NHS (0) 
mdata <- mdata %>%
  mutate(disease = case_when(
    Symptom == "NHS" ~ 0, 
    Symptom == "Asymptomatic C" ~ 1,
    Symptom == "Symptomatic C" ~ 1
    )
  )

# "sym" column for asym (0) and sym (1)
mdata <- mdata %>%
  mutate(sym = case_when(
    Symptom == "Asymptomatic C" ~ 0, 
    Symptom == "Symptomatic C" ~ 1
  ))

# These lists will be used for loops :D
list_DNA_Types <- c("mtND1", "mtND5", "mtATP6", "mtCOII", "mtCytB")
list_Group_Types <- c("NHS", "Asymptomatic C", "Symptomatic C")

```

```{r Boxplots Mitochondrial DNA}
p <- list()
i = 1

for(DNA_Type in list_DNA_Types){
    p[[i]] <- ggplot(mdata, aes_string(x = "Symptom", y = DNA_Type)) +
      geom_boxplot() +
      labs(title = paste(DNA_Type),
           y = "copies/ml") +
      theme_minimal() +
      scale_fill_brewer(palette = "Set1") +
      theme(text = element_text(size=10))
    i <- i+1
}
grid.arrange(grobs = p, ncol = 2)

```

<<<<<<< Updated upstream
```{r logistic regression for just mtCOII}

  mit_model <- glm(disease~mtCOII, data = mdata, family = binomial)
  summary(mit_model)
=======
-------------------------------------------------
Can we predict whether someone has Chagas Disease
based on the DNA Type's copies/ml ?
-------------------------------------------------
```{r Univariable Logistic Regression Mitochondrial DNA }

# Empty list to store ggplots
plot_list <- list()

# Logistic Regression where DNA Type is the predictor of disease
for (DNA_Type in list_DNA_Types) {
  formula_text <- paste("disease ~", DNA_Type)
  mit_model <- glm(as.formula(formula_text), data = mdata, family = binomial)
>>>>>>> Stashed changes
  prob <- predict(mit_model, type = "response")
  roc_obj <- roc(mdata$disease, prob)
  
  # Generate ggplot ROC plot
  roc_plot <- ggroc(roc_obj) +
<<<<<<< Updated upstream
    ggtitle("mtCOII ROC") +
=======
    ggtitle(paste(DNA_Type, "ROC")) +
>>>>>>> Stashed changes
    theme_minimal()
 
  # Calculate AUC
  auc_value <- auc(roc_obj)
<<<<<<< Updated upstream
  auc_message <- paste0("mtCOII AUC: ", auc_value)
=======
  auc_message <- paste0(DNA_Type," AUC: ", auc_value)
>>>>>>> Stashed changes
  print(auc_message)
  
  # Plot ROC
  plot(roc_plot)
<<<<<<< Updated upstream

```

-------------------------------------------------
Can we predict whether someone has Chagas Disease
based on the DNA Type's copies/ml ?
-------------------------------------------------
```{r Univariable Logistic Regression Mitochondrial DNA }

# Empty list to store ggplots
plot_list <- list()

# Logistic Regression where DNA Type is the predictor of disease
for (DNA_Type in list_DNA_Types) {
  formula_text <- paste("disease ~", DNA_Type)
  mit_model <- glm(as.formula(formula_text), data = mdata, family = binomial)
  prob <- predict(mit_model, type = "response")
  roc_obj <- roc(mdata$disease, prob)
  
  # Generate ggplot ROC plot
  roc_plot <- ggroc(roc_obj) +
    ggtitle(paste(DNA_Type, "ROC")) +
    theme_minimal()
 
  # Calculate AUC
  auc_value <- auc(roc_obj)
  auc_message <- paste0(DNA_Type," AUC: ", auc_value)
  print(auc_message)
  
  # Plot ROC
  plot(roc_plot)
  
  # Plot all the ROCs
  plot_list[[DNA_Type]] <- roc_plot
}

grid.arrange(grobs = plot_list, 
               top = textGrob("DNA Types Predict Diseased vs NHS",
                              just = "top", 
                              gp = gpar(fontsize = 16, fontface = "bold")),
               ncol = 4)
```

```{r Multivariable Logistic Regression Mitochondrial DNA}
 
  # Multivariate Logistic Regression
  mit_model <- glm(disease~mtND1 + mtND5 + mtATP6 + mtCOII + mtCytB, data = mdata, family = binomial)
  prob <-  predict(mit_model, type = "response")
  roc_obj <- roc(mdata$disease, prob)
  plot(roc_obj)
  
  # Calculate AUC
  auc_value <- auc(roc_obj)
  auc_message <- paste0(" AUC: ", auc_value)
  print(auc_message)

```


```{r Multivariable Logistic Regression Mitochondrial DNA}
 
  # Multivariate Logistic Regression
  mit_model <- glm(disease~mtND1 + mtND5 + mtATP6 + mtCOII + mtCytB, data = mdata, family = binomial)
  prob <-  predict(mit_model, type = "response")
  roc_obj <- roc(mdata$disease, prob)
  plot(roc_obj)
  
  # Calculate AUC
  auc_value <- auc(roc_obj)
  auc_message <- paste0(" AUC: ", auc_value)
  print(auc_message)

```

Can a DNA Type Predict Chagas Disease? 
Logisitc Regression AUC Results:
[1] "mtND1 AUC: 0.836111111111111"
[1] "mtND5 AUC: 0.583333333333333"
[1] "mtATP6 AUC: 0.813888888888889"
[1] "mtCOII AUC: 0.441666666666667"
[1] "mtCytB AUC: 0.544444444444444"
Results: 
mtND1 & mtATP6 AUC > 0.8
mtCOII < 0.5
mtCOII has a negative association with Chagas Disease


Can multiple DNA Types Predict Chagas Disease together? 
Multivariate Logsitic Regression 
Results: 
mtND1 + mtND5 + mtATP6 + mtCOII + mtCytB AUC: 1


-------------------------------------------------
Can we predict whether someone is Symptomatic or Asymptomatic
based on the DNA Type's copies/ml ?
-------------------------------------------------
```{r Logistic Regression Mitochondrial DNA }

# Remove rows with NAs in the 'sym' column
asmdata <- mdata %>%
  filter(!is.na(sym))

# Empty list to store ggplots
plot_list <- list()

# Logistic Regression where DNA Type is the predictor of Asymptomatic & Symptomatic
for (DNA_Type in list_DNA_Types) {
  formula_text <- paste("sym ~", DNA_Type)
  mit_model <- glm(as.formula(formula_text), data = asmdata, family = binomial)
  prob <- predict(mit_model, type = "response")
  roc_obj <- roc(asmdata$sym, prob)
  
  # Generate ggplot ROC plot
  roc_plot <- ggroc(roc_obj) +
    ggtitle(paste(DNA_Type, "ROC")) +
    theme_minimal()
 
  # Calculate AUC
  auc_value <- auc(roc_obj)
  auc_message <- paste0(DNA_Type," AUC: ", auc_value)
  print(auc_message)
  
  # Plot ROC
  plot(roc_plot)
  
  # Store all the ROC plots in a list
  plot_list[[DNA_Type]] <- roc_plot
}



grid.arrange(grobs = plot_list, 
               top = textGrob("DNA Types Predict Asymptomatic vs Symptomatic ",
                              just = "top", 
                              gp = gpar(fontsize = 16, fontface = "bold")),
               ncol = 4)
```

```{r Multivariate Logistic Regression Mitochondrial DNA}

  # Multivariate Logistic Regression
  mit_model <- glm(sym~mtND1 + mtND5 + mtATP6 + mtCOII + mtCytB, data = asmdata, family = binomial)
  prob <-  predict(mit_model, type = "response")
  roc_obj <- roc(asmdata$sym, prob)
  plot(roc_obj)
  
  # Calculate AUC
  auc_value <- auc(roc_obj)
  auc_message <- paste0(" AUC: ", auc_value)
  print(auc_message)


```
Can individual DNA Types classify Symptomatic vs Asymptomatic?
Logisitc Regression AUC Results:
[1] "mtND1 AUC: 0.991111111111111"
[1] "mtND5 AUC: 1"
[1] "mtATP6 AUC: 1"
[1] "mtCOII AUC: 0.924444444444445"
[1] "mtCytB AUC: 0.942222222222222"
Results:
All AUCs > 0.9
Our logistic regression models classify asym from sym with high accuracy.

Can DNA Type when grouped, classify Symptomatic vs Asymptomatic ?
mtND1 + mtND5 + mtATP6 + mtCOII + mtCytB: AUC: 1


```{r Mitochondrial DNA AUC Plot No Legend}
library(ggplot2)
library(dplyr)
library(tidyr)

# Create the dataframe
# AUC data
data <- data.frame(
  Gene = c("MtND1", "MtND5", "MtATP6", "MtcCOII", "MtCytB"),
  Control_vs_Disease = c(0.836, 0.583, 0.813, 0.441, 0.544),
  Sym_vs_Asym = c(0.991, 1, 1, 0.924, 0.942)
)

# Pivot to long format
data_long <- pivot_longer(data, 
                          cols = -Gene, 
                          names_to = "Comparison", 
                          values_to = "AUC")

# Plot
ggplot(data_long, aes(x = AUC, y = Gene, fill = Comparison)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_vline(xintercept = 0.8, linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_manual(
    values = c("Control_vs_Disease" = "#3A7EC5", "Sym_vs_Asym" = "#E85B6F"),
    labels = c("Control vs Disease\n  (Diagnostic)" ,"Sym vs Asym\n  (Prognostic)"),
  ) +
  labs(
    title = "Predictability of Mitochondrial DNA Types",
    x = "AUC", y = "Biomarker",
    fill = "Prediction"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    legend.spacing.y = unit(2, "cm"),  # vertical spacing
    plot.background = element_rect(fill = "white", color = NA),
    panel.background = element_rect(fill = "white", color = NA),
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 18),
    axis.title = element_text(face = "bold"),
    legend.title = element_text(face = "bold")
  )

# save as png
ggsave("Mitochondrial_DNA_AUC_Comparison.png", width = 7, height = 4, dpi = 300)

# Classify role
gene_classification <- data %>%
  mutate(
    Role = case_when(
      Control_vs_Disease >= 0.8 & Sym_vs_Asym >= 0.8 ~ "Diagnostic &\n Prognostic",
      Control_vs_Disease >= 0.8 ~ "Diagnostic",
      Sym_vs_Asym >= 0.8 ~ "Prognostic",
      TRUE ~ "Neither"
    )
  )

# Reshape for ggplot
data_long <- pivot_longer(gene_classification,
                          cols = c(Control_vs_Disease, Sym_vs_Asym),
                          names_to = "Comparison",
                          values_to = "AUC") %>%
  mutate(
    ComparisonLabel = case_when(
      Comparison == "Control_vs_Disease" ~ "With vs W/o Chagas",
      Comparison == "Sym_vs_Asym" ~ "Asym vs Sym"
    )
  )

# Base plot WITHOUT legend
plot_main <- ggplot(data_long, aes(x = AUC, y = reorder(Gene, AUC), fill = Role)) +
  geom_col() +
  facet_wrap(~ComparisonLabel, scales = "free_y") +
  geom_vline(xintercept = 0.8, linetype = "dashed", color = "black", linewidth = 0.5) +
  scale_fill_manual(
    values = c(
      # Pink = "#DD5E66",
      # Blue = "#2d0594",
      # Purple = "#9512A1",
      "Diagnostic &\n Prognostic" = "#9512A1",
      "Diagnostic" = "#DD5E66",
      "Prognostic" = "#2d0594",
      "Neither" = "gray70"
    )
  ) +
  labs(
    title = "AUC Values for MtDNA Types in Chagas Disease",
    x = "AUC", y = "Mitochondrial DNA Type"
  ) +
  theme_minimal(base_size = 30) +
  theme(
    strip.text = element_text(face = "bold", size = 40),
    plot.title = element_text(face = "bold", size = 40),
    axis.title = element_text(face = "bold"),
    legend.position = "none"
  )
plot(plot_main)
# Save without legend
ggsave("Mitochondrial_DNA_AUC_Without_Legend.png", plot = plot_main, width = 16, height = 9, dpi = 300)
```

```{r Mitochondrial DNA Plot Legend}
# Create a dummy plot JUST to extract the legend
plot_legend <- ggplot(data_long, aes(x = AUC, y = Gene, fill = Role)) +
  geom_col() +
  scale_fill_manual(
    values = c(
      # Pink = "#DD5E66",
      # Blue = "#2d0594",
      # Purple = "#9512A1",
      "Diagnostic &\n Prognostic" = "#9512A1",
      "Diagnostic" = "#DD5E66",
      "Prognostic" = "#2d0594",
      "Neither" = "gray70"
    )
  ) +
  theme_minimal() +
  theme(legend.title = element_text(face = "bold")) +
  labs(fill = "Biomarker Role")

# Extract legend using cowplot
library(cowplot)
legend_only <- cowplot::get_legend(plot_legend)

plot(legend_only)
# Save the legend
ggsave("Mitochondrial_DNA_AUC_Legend.png", plot = legend_only, width = 4, height = 3, dpi = 300)
```

```{r Protein Parameter DNA Plot No Legend}
library(ggplot2)
library(dplyr)
library(tidyr)
library(tibble)

# AUC data
diagnosis_auc <- tribble(
  ~Biomarker, ~Sample, ~AUC,
  "Copeptin", "Serum", 1,
  "Copeptin", "Plasma", 1,
  "HnRNPA1", "Serum", 0.9888889,
  "HnRNPA1", "Plasma", 0.9847222,
  "Endostatin", "Serum", 0.9222222,
  "Endostatin", "Plasma", 0.9513889,
  "Myostatin", "Serum", 0.75,
  "Myostatin", "Plasma", 0.7013889,
  "8-OhDG", "Serum", 0.9972222,
  "8-OhDG", "Plasma", 1,
  "PARP1", "Serum", 1,
  "PARP1", "Plasma", 1
)

prognosis_auc <- tribble(
  ~Biomarker, ~Sample, ~AUC,
  "Copeptin", "Serum", 0.9822222,
  "Copeptin", "Plasma", 1,
  "HnRNPA1", "Serum", 0.7066667,
  "HnRNPA1", "Plasma", 0.6133333,
  "Endostatin", "Serum", 0.8911111,
  "Endostatin", "Plasma", 0.9155556,
  "Myostatin", "Serum", 1,
  "Myostatin", "Plasma", 0.9955556,
  "8-OhDG", "Serum", 0.9911111,
  "8-OhDG", "Plasma", 0.8355556,
  "PARP1", "Serum", 0.6044444,
  "PARP1", "Plasma", 0.5244444
)

diagnosis_auc <- diagnosis_auc %>% mutate(Group = "With vs W/o Chagas")
prognosis_auc <- prognosis_auc %>% mutate(Group = "Asym vs Sym")

combined_auc <- bind_rows(diagnosis_auc, prognosis_auc) %>%
  mutate(Label = paste(Biomarker, Sample))

classification_df <- tribble(
  ~Biomarker, ~Classification,
  "Copeptin", "Both",
  "HnRNPA1", "Diagnostic",
  "Endostatin", "Both",
  "Myostatin", "Prognostic",
  "8-OhDG", "Both",
  "PARP1", "Diagnostic"
)

combined_auc <- combined_auc %>%
  left_join(classification_df, by = "Biomarker") %>%
  mutate(Classification = replace_na(Classification, "Neither"))

# Plot without legend
plot_protein_main <- ggplot(combined_auc, aes(x = AUC, y = reorder(Label, AUC), fill = Classification)) +
  geom_col() +
  facet_wrap(~Group, scales = "free_y") +
  geom_vline(xintercept = 0.8, linetype = "dashed", color = "black", linewidth = 0.6) +
  scale_fill_manual(
    values = c(
      # Pink = "#DD5E66",
      # Blue = "#2d0594",
      # Purple = "#9512A1",
      "Both" = "#9512A1",
      "Diagnostic" = "#DD5E66",
      "Prognostic" = "#2d0594",
      "Neither" = "gray70"
    )
  ) +
  labs(
    title = "AUC Values for Biomarkers in Chagas Disease",
    x = "AUC", y = "Biomarker"
  ) +
  theme_minimal(base_size = 40) +
  theme(
    strip.text = element_text(face = "bold", size = 35),
    plot.title = element_text(face = "bold", size = 35),
    plot.subtitle = element_text(size = 12),
    axis.title = element_text(face = "bold"),
    legend.position = "none"
  )

plot(plot_protein_main)
# Save the main plot
ggsave("Protein_AUC_Plot_Only.png", plot = plot_protein_main, width = 19, height = 14, dpi = 300)

```

```{r Protein Paramter DNA Legend Only}

# Dummy plot to extract the legend
plot_protein_legend <- ggplot(combined_auc, aes(x = AUC, y = Label, fill = Classification)) +
  geom_col() +
  scale_fill_manual(
    values = c(
      # Pink = "#DD5E66",
      # Blue = "#2d0594",
      # Purple = "#9512A1",
      "Diagnostic &\n Prognostic" = "#9512A1",
      "Diagnostic" = "#DD5E66",
      "Prognostic" = "#2d0594",
      "Neither" = "gray70"
    )
  ) +
  theme_minimal() +
  labs(fill = "Biomarker\nRole") +
  theme(legend.title = element_text(face = "bold"))

# Extract using cowplot
library(cowplot)
legend_only <- get_legend(plot_protein_legend)

# Save legend only as image
ggsave("Protein_AUC_Legend_Only.png", plot_grid(legend_only), width = 4, height = 3, dpi = 300)

```

--------------------
Radar Plot
- radar plot for protein parameter average for each group
- just take the log of max, min, average
--------------------
``` {r radar}

#Group averages
avg_data <- data %>%
  group_by(Symptom) %>%
  summarise(across(matches("(_Serum|_Plasma)$"), mean, na.rm = TRUE)) %>%
  as.data.frame()

log_data <- avg_data %>%
  mutate(across(where(is.numeric), log))

# Set rownames from Symptom and remove that column
rownames(log_data) <- log_data$Symptom
log_data$Symptom <- NULL

# Set min and max values explicitly
min_val <- 0  # your observed raw minimum
max_val <- 8  # your observed raw maximum

custom_labels <- c("Copeptin (S)", "HnRNPA1 (S)", "Endostatin (S)", "Myostatin (S)",
                   "8-OHdG (S)", "PARP1 (S)", "Copeptin (P)", "HnRNPA1 (P)", "Endostatin (P)", "Myostatin (P)",
                   "8-OHdG (P)", "PARP1 (P)")

# Create df with required min and max rows
df_radar <- log_data
colnames(df_radar) <- custom_labels 
df_radar <- rbind(rep(max_val, ncol(df_radar)),
                  rep(min_val, ncol(df_radar)),
                  df_radar)

# Define your custom sizes
axis_label_size <- 0.8     # Size of the axis label text
variable_label_size <- 1.2 # Size of the variable labels (vlcex)
title_size <- 1.5          # Size of the title

# Plot the radar chart
radarchart(df_radar,
           axistype = 1,
           caxislabels = round(seq(min_val, max_val, length.out = 5), 2),
           pcol = wes_palette("Darjeeling1"),
           plwd = 2,
           cglcol = "grey",
           cglty = 1,
           axislabcol = "black",
           calcex = axis_label_size,  # axis label size
           vlcex = variable_label_size,  # variable name size
           title = "Log Averages of Protein Parameters by Symptom")

# Change the title size using base graphics
title("Log Averages of Protein Parameters by Symptom", cex.main = title_size)

# Add legend for the groups
legend("bottomleft",
       legend = rownames(df_radar)[3:nrow(df_radar)],
       col = wes_palette("Darjeeling1"),
       lty = 1, lwd = 4, bty = "n")

# Save it
ggsave("radar_plot_protein_parameters.png", width = 10, height = 10, dpi = 300)

```

**OLD STUFF**
--------------------
Can a biomarker correctly detect whether or not someone has chagas?
*LDA*
--------------------

``` {r sensspec}

#Remove ID for LDA
data <- data[, -1]

#Linear model
lda.mod <- lda(Symptom ~ ., data = data)
lda.mod

#LDA prediction
lda.pred <- predict(lda.mod, data)
lda.pred.class <- lda.pred$class
table(lda.pred.class, data$Symptom) 
lda.detail <- cbind(as.character(lda.pred$class), round(lda.pred$posterior,8))

#Plot LDA model
plot(lda.mod)

#ataframe with first two discriminants
plot_data <- data.frame(LD1 = lda.pred$x[,1],
                        LD2 = lda.pred$x[,2],
                        Group = data$Symptom)

#plotting seperation with first two discriminants
ggplot(plot_data, aes(x = LD1, y = LD2, color = Group)) +
  geom_point(size = 3, alpha = 0.7) +
  labs(title = "LDA: Projection onto LD1 and LD2",
       x = "Linear Discriminant 1",
       y = "Linear Discriminant 2") +
  theme_minimal() +
  theme(text = element_text(size=14))

#Which biomarkers contribute the most?
coef_df <- as.data.frame(lda.mod$scaling)
coef_df$Variable <- rownames(coef_df)

#LD1
coef_df[order(abs(coef_df$LD1), decreasing = TRUE), c("Variable", "LD1")]

#LD2
coef_df[order(abs(coef_df$LD2), decreasing = TRUE), c("Variable", "LD2")]

```
--------------------
Can we predict whether a participant is Asymptomatic or Symptomatic based on the different serum values??
*Random Forest, bagging, boosting*
--------------------
``` {r copepserum}

#Mutate variable to add asymptomatic vs symptomatic
data <- data %>%
  filter(Symptom %in% c("ASYM", "SYM")) %>%
  mutate(
    a_or_s = case_when(
      Symptom == "ASYM" ~ 0, #asymptomatic
      Symptom == "SYM" ~ 1, #symptomatic
      TRUE ~ NA_real_
    )
  )

#make sure its a factor
data$a_or_s <- as.factor(data$a_or_s)

#create training and test set
set.seed(1)
train = sample(dim(data)[1], dim(data) [1]/2)
data.train = data[train, ]
data.test = data[-train, ]

#build the tree on training data
tree.data = tree(a_or_s ~ Copeptin_Serum + HnRNPA1_Serum + Endostatin_Serum + Myostatin_Serum + etOhDG_Serum + PARP1_Serum, data, subset = train)

#pruned tree
cv.data = cv.tree(tree.data, FUN=prune.misclass)
cv.data
plot(cv.data$size,cv.data$dev,type="b")
prune.data=prune.misclass(tree.data, best = sqrt(6))
plot(prune.data)

#Getting % of correct predictions for pruned tree
prune.pred = predict(prune.data,data.test,type="class")
tab <- table(prune.pred,data.test$a_or_s)
tab
(tab[1,1]+tab[2,2])/sum(tab)

#Bagging and Random Forests
data$a_or_s <- as.numeric(as.character(data$a_or_s))

#Bagging
bag.data = randomForest(a_or_s ~Copeptin_Serum + HnRNPA1_Serum + Endostatin_Serum + Myostatin_Serum + etOhDG_Serum + PARP1_Serum, data = data.train, mtry = 6, ntree = 100, importance = T)
bag.pred = predict(bag.data, data.test)

#Get predictions on test set from bagged tree
tabbag <- table(bag.pred,data.test$a_or_s)
tabbag
tabbag[1,1]+tabbag[2,2]/sum(tabbag) #% of correct predictions
importance(bag.data)
varImpPlot(bag.data)

#Random Forest
rf.data = randomForest(a_or_s ~ Copeptin_Serum + HnRNPA1_Serum + Endostatin_Serum + Myostatin_Serum + etOhDG_Serum + PARP1_Serum, data = data.train, mtry = sqrt(6), ntree = 100, importance = T)
rf.pred = predict(rf.data, data.test)

#Get predictions on test set from random forest
tabrf <- table(rf.pred, data.test$a_or_s)
tabrf
(tabrf[1.1]+tabrf[2,2])/sum(tabrf) #% of correct predictions
importance(rf.data)
varImpPlot(rf.data)

#Boosting
#Changing a_or_s into a numeric variable
data$a_or_s <- as.numeric(data$a_or_s)
boost.data = gbm(a_or_s ~ Copeptin_Serum + HnRNPA1_Serum + Endostatin_Serum + Myostatin_Serum + etOhDG_Serum + PARP1_Serum, data = data[train,], distribution="bernoulli",n.trees=5000,interaction.depth=3,shrinkage=.001, bag.fraction = 0.3, n.minobsinnode = 1)
summary(boost.data, las = 1)
yhat.boost = predict(boost.data, newdata=data[-train,], n.trees=5000)
yhat.boost[1:10] 

#Find optimal n.trees via cross-validation
boost.data = gbm(a_or_s ~ Copeptin_Serum + HnRNPA1_Serum + Endostatin_Serum + Myostatin_Serum + etOhDG_Serum + PARP1_Serum, data = data[train,],distribution="bernoulli",n.trees=5000,interaction.depth=3,shrinkage=.001, bag.fraction = 0.3, n.minobsinnode = 1, cv.folds=3)
summary(boost.data, las=1)
best.ntrees <- gbm.perf(boost.data, method"cv", plot.it=TRUE)
phat.boost = predict(boost.data, type="response", newdata=data[-train,], n.trees=best.ntrees)
phat.boost[1:10]
yhat.boost=ifelse(phat.boost > 0.5, "Yes", "No")
yhat.boost[1:10]

tabboost <- table(yhat.boost, data$a_or_s[-train])
(tabboost[1,1]+tabboost[2,2])/sum(tabboost) #% of correct predictions

#Proportion of 0s in a_or_s
prop_zeros <- sum(data$a_or_s[train] == 0, na.rm = TRUE) / length(data$a_or_s[train])
prop_zeros
```














