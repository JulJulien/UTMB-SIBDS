---
title: "Vaccine"
author: "Summer"
date: "2025-07-01"
output: html_document
---

multinomial logisitc regression


--------------------
Key
--------------------
NHS: Normal healthy subjects
ASYM: Chagas disease patients with no clinical symptoms
SYM: Chagas disease patients with clinical symptoms
ID: Identification marker for 1 of the 42 patients studied
chag_pres: person doesn't have or does have chagas disease (0 or 1)
a_or_s: whether a person is asymptomatic or symptomatic

--------------------
Definitions
--------------------
Serum: Liquid secreted after blood clots
Plasma: Liquid secreted when anti-coagulant is applied to blood
Copeptin:
- Peptide derived from the precursor of vasopressin
- Serves as a surrogate biomarker for vasopressin release
- Useful id diagnosing diabetes insipidus, heart failure, and acute myocardial infarction since vasopression is unstable in blood but copeptin is not
HnRNPA1:
- RNA binding protein involved in pre-mRNA splicing, transport, and stability
- Regulates gene expression post-transcriptionally
- Mutations associated with neurodegenerative diseases
Endostatin:
- Natural inhibtor of angiogensis
- Blocks formation of new blood vessels (tumor suppression)
Myostatin:
- Inhibits muscle growth
- Mutations that inactivate myostatin lead to muscle hypertrophy
8-OhDG:
- Marker of oxidative DNA damage
- Formed when DNA is attacked by reactive oxygen species
- Elevated levels seen in cancer, neurodegenerative diseases, diabetes, and agings. Assess oxidative stress
PARP1:
- DNA repair enzyme
- Detects DNA strand breaks and helps repair them by adding ADP-ribose chains to itself and other proteins

--------------------
Install important packages and libraries
--------------------
```{r package}
library(broom)
library(corrplot)
library(dplyr)
library(emmeans)
library(ggplot2)
library(ggpubr)
library(ggrepel)
library(gridExtra)
library(glmnet)
library(gbm)
library(ISLR)
library(leaps)
library(MASS)
library(pROC)
library(readxl)
library(rlang)
library(randomForest)
library(tidyverse)
library(tidyr)
library(tree)
library(writexl)
```

--------------------
Load data from excel
--------------------
```{r load}
file_path <- ("/Users/summerjohnson/Documents/GitHub/UTMB-SIBDS/proteinparam.xlsx")
data <- read_xlsx("/Users/summerjohnson/Documents/GitHub/UTMB-SIBDS/proteinparam.xlsx")

#Create columns for each protein parameter and test, new column ordinal chagas present
data <- data %>%
  pivot_wider(names_from = Moleculae, values_from = c(Serum, Plasma),
              names_glue = "{Moleculae}_{.value}") %>%
  mutate(
    chag = case_when(
      Symptom == "NHS" ~ 0, 
      Symptom == "ASYM" | Symptom == "SYM" ~ 1,
      TRUE ~ NA_real_
    ),
    sym = case_when(
      Symptom == "ASYM" ~ 0,
      Symptom == "SYM" ~ 1,
      TRUE ~ NA_real_
    )
  )
```


--------------------
EDA
--------------------
``` {r EDA}

#Summarize data
summary(data)

#Visualize which biomarkers seperate groups (chagas vs no chagas) well
df_long <- data %>%
  pivot_longer(cols = ends_with("_Serum") | ends_with("_Plasma"),
               names_to = "marker",
               values_to = "value")

plot_eda <- ggplot(df_long, aes(x = factor(chag_pres), y = value, fill = factor(chag_pres))) +
  geom_boxplot() +
  facet_wrap(~ marker, scales = "free") +
  theme_minimal()


```

--------------------
Can each protein level predict whether or not someone has chagas disease?
*logistic regression, ROC, AUC*
--------------------
``` {r user}
#Loop for each protein and sample
run_logistic_analysis <- function(data, protein_name, sample_type = c("Serum", "Plasma")) {
  sample_type <- match.arg(sample_type)
  
  #Construct the column name
  var_name <- paste0(protein_name, "_", sample_type)
  
  #Check if the variable exists
  if (!var_name %in% names(data)) {
    stop(paste("Variable", var_name, "not found in the data."))
  }
  
  #Formula for logistic regression
  formula <- as.formula(paste("chag ~", var_name))
  
  #Fit logistic regression model
  log.reg <- glm(formula, data = data, family = "binomial")
  print(summary(log.reg))
  
  #Odds ratios and CI
  cat("\nOdds Ratios:\n")
  print(exp(coef(log.reg)))
  
  cat("\n95% CI for Odds Ratios:\n")
  print(exp(confint(log.reg)))
  
  #Predicted probabilities and classes
  pred.prob <- predict(log.reg, type = "response")
  pred.class <- ifelse(pred.prob > 0.5, 1, 0)
  
  #ROC and AUC
  roc_log <- roc(data$chag, pred.prob)
  cat("\nAUC:", auc(roc_log), "\n")
  plot(roc_log, main = paste("ROC Curve -", var_name))
  
  #Regularization with cv.glmnet (L2 penalty: alpha = 0)
  set.seed(123)
  x <- cbind(var = data[[var_name]], dummy = rnorm(nrow(data), 0, 1e-6))
  x <- as.matrix(x)
  y <- as.factor(data$chag)
  
  cvfit <- cv.glmnet(x, y, family = "binomial", alpha = 0)
  plot(cvfit, main = paste("CV Error -", var_name))
  cat("\nRegularized Coefficients (lambda.min):\n")
  print(coef(cvfit, s = "lambda.min"))
  
  invisible(list(model = log.reg, auc = auc(roc_log), cv_model = cvfit))
}

#Run logistic regression for each protein and sample
run_logistic_analysis(data, protein_name = "Copeptin", sample_type = "Serum")
run_logistic_analysis(data, protein_name = "Copeptin", sample_type = "Plasma")
run_logistic_analysis(data, protein_name = "HnRNPA1", sample_type = "Serum")
run_logistic_analysis(data, protein_name = "HnRNPA1", sample_type = "Plasma")
run_logistic_analysis(data, protein_name = "Endostatin", sample_type = "Serum")
run_logistic_analysis(data, protein_name = "Endostatin", sample_type = "Plasma")
run_logistic_analysis(data, protein_name = "Myostatin", sample_type = "Serum")
run_logistic_analysis(data, protein_name = "Myostatin", sample_type = "Plasma")
run_logistic_analysis(data, protein_name = "etOhDG", sample_type = "Serum")
run_logistic_analysis(data, protein_name = "etOhDG", sample_type = "Plasma")
run_logistic_analysis(data, protein_name = "PARP1", sample_type = "Serum")
run_logistic_analysis(data, protein_name = "PARP1", sample_type = "Plasma")

```
--------------------
AUC Results (with vs without chagas)
--------------------
Copeptin Serum: 1
Copeptin Plasma: 1
HnRNPA1 Serum:0.9888889
HnRNPA1 Plasma:0.9847222
Endostatin Serum:0.9222222
Endostatin Plasma:0.9513889
Myostatin Serum:0.75
Myostatin Plasma:0.7013889
8-OhDG Serum:0.9972222
8-OhDG Plasma:1
PARP1 Serum:1
PARP1 Plasma:1


--------------------
Can a biomarker correctly detect whether or not someone has chagas?
*LDA*
--------------------
``` {r sensspec}

#Remove ID for LDA
data <- data[, -1]

#Linear model
lda.mod <- lda(Symptom ~ ., data = data)
lda.mod

#LDA prediction
lda.pred <- predict(lda.mod, data)
lda.pred.class <- lda.pred$class
table(lda.pred.class, data$Symptom) 
lda.detail <- cbind(as.character(lda.pred$class), round(lda.pred$posterior,8))

#Plot LDA model
plot(lda.mod)

#ataframe with first two discriminants
plot_data <- data.frame(LD1 = lda.pred$x[,1],
                        LD2 = lda.pred$x[,2],
                        Group = data$Symptom)

#plotting seperation with first two discriminants
ggplot(plot_data, aes(x = LD1, y = LD2, color = Group)) +
  geom_point(size = 3, alpha = 0.7) +
  labs(title = "LDA: Projection onto LD1 and LD2",
       x = "Linear Discriminant 1",
       y = "Linear Discriminant 2") +
  theme_minimal() +
  theme(text = element_text(size=14))

#Which biomarkers contribute the most?
coef_df <- as.data.frame(lda.mod$scaling)
coef_df$Variable <- rownames(coef_df)

#LD1
coef_df[order(abs(coef_df$LD1), decreasing = TRUE), c("Variable", "LD1")]

#LD2
coef_df[order(abs(coef_df$LD2), decreasing = TRUE), c("Variable", "LD2")]

```

--------------------
Can we predict whether a participant is Asymptomatic or Symptomatic based on the different serum values??
*Random Forest, bagging, boosting*
--------------------
``` {r copepserum}

#Mutate variable to add asymptomatic vs symptomatic
data <- data %>%
  filter(Symptom %in% c("ASYM", "SYM")) %>%
  mutate(
    a_or_s = case_when(
      Symptom == "ASYM" ~ 0, #asymptomatic
      Symptom == "SYM" ~ 1, #symptomatic
      TRUE ~ NA_real_
    )
  )

#make sure its a factor
data$a_or_s <- as.factor(data$a_or_s)

#create training and test set
set.seed(1)
train = sample(dim(data)[1], dim(data) [1]/2)
data.train = data[train, ]
data.test = data[-train, ]

#build the tree on training data
tree.data = tree(a_or_s ~ Copeptin_Serum + HnRNPA1_Serum + Endostatin_Serum + Myostatin_Serum + etOhDG_Serum + PARP1_Serum, data, subset = train)

#pruned tree
cv.data = cv.tree(tree.data, FUN=prune.misclass)
cv.data
plot(cv.data$size,cv.data$dev,type="b")
prune.data=prune.misclass(tree.data, best = sqrt(6))
plot(prune.data)

#Getting % of correct predictions for pruned tree
prune.pred = predict(prune.data,data.test,type="class")
tab <- table(prune.pred,data.test$a_or_s)
tab
(tab[1,1]+tab[2,2])/sum(tab)

#Bagging and Random Forests
data$a_or_s <- as.numeric(as.character(data$a_or_s))

#Bagging
bag.data = randomForest(a_or_s ~Copeptin_Serum + HnRNPA1_Serum + Endostatin_Serum + Myostatin_Serum + etOhDG_Serum + PARP1_Serum, data = data.train, mtry = 6, ntree = 100, importance = T)
bag.pred = predict(bag.data, data.test)

#Get predictions on test set from bagged tree
tabbag <- table(bag.pred,data.test$a_or_s)
tabbag
tabbag[1,1]+tabbag[2,2]/sum(tabbag) #% of correct predictions
importance(bag.data)
varImpPlot(bag.data)

#Random Forest
rf.data = randomForest(a_or_s ~ Copeptin_Serum + HnRNPA1_Serum + Endostatin_Serum + Myostatin_Serum + etOhDG_Serum + PARP1_Serum, data = data.train, mtry = sqrt(6), ntree = 100, importance = T)
rf.pred = predict(rf.data, data.test)

#Get predictions on test set from random forest
tabrf <- table(rf.pred, data.test$a_or_s)
tabrf
(tabrf[1.1]+tabrf[2,2])/sum(tabrf) #% of correct predictions
importance(rf.data)
varImpPlot(rf.data)

#Boosting
#Changing a_or_s into a numeric variable
data$a_or_s <- as.numeric(data$a_or_s)
boost.data = gbm(a_or_s ~ Copeptin_Serum + HnRNPA1_Serum + Endostatin_Serum + Myostatin_Serum + etOhDG_Serum + PARP1_Serum, data = data[train,], distribution="bernoulli",n.trees=5000,interaction.depth=3,shrinkage=.001, bag.fraction = 0.3, n.minobsinnode = 1)
summary(boost.data, las = 1)
yhat.boost = predict(boost.data, newdata=data[-train,], n.trees=5000)
yhat.boost[1:10] 

#Find optimal n.trees via cross-validation
boost.data = gbm(a_or_s ~ Copeptin_Serum + HnRNPA1_Serum + Endostatin_Serum + Myostatin_Serum + etOhDG_Serum + PARP1_Serum, data = data[train,],distribution="bernoulli",n.trees=5000,interaction.depth=3,shrinkage=.001, bag.fraction = 0.3, n.minobsinnode = 1, cv.folds=3)
summary(boost.data, las=1)
best.ntrees <- gbm.perf(boost.data, method"cv", plot.it=TRUE)
phat.boost = predict(boost.data, type="response", newdata=data[-train,], n.trees=best.ntrees)
phat.boost[1:10]
yhat.boost=ifelse(phat.boost > 0.5, "Yes", "No")
yhat.boost[1:10]

tabboost <- table(yhat.boost, data$a_or_s[-train])
(tabboost[1,1]+tabboost[2,2])/sum(tabboost) #% of correct predictions

#Proportion of 0s in a_or_s
prop_zeros <- sum(data$a_or_s[train] == 0, na.rm = TRUE) / length(data$a_or_s[train])
prop_zeros
```














